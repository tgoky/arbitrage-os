// schema.prisma - COMPLETE WITH CREDITS SYSTEM
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

model Workspace {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String    @map("user_id") @db.Uuid
  name        String    @db.VarChar(255)
  slug        String    @db.VarChar(255)
  description String?
  color       String?   @default("bg-blue-700") @db.VarChar(50)
  created_at  DateTime? @default(dbgenerated("timezone('utc'::text, now())")) @map("created_at") @db.Timestamptz(6)
  updated_at  DateTime? @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt @map("updated_at") @db.Timestamptz(6)

  deliverables       Deliverable[]
  creditTransactions CreditTransaction[]
  
  @@unique([user_id, slug])
  @@index([slug], map: "idx_workspaces_slug")
  @@index([user_id], map: "idx_workspaces_user_id")
  @@map("workspaces")
  @@schema("public")
}

model Deliverable {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String   @db.VarChar(255)
  content      String   @db.Text
  type         String   @db.VarChar(100)
  user_id      String   @db.Uuid
  workspace_id String   @db.Uuid
  client_id    String?  @db.Uuid
  metadata     Json?
  tags         String[]
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @updatedAt @db.Timestamptz(6)

  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@index([user_id], map: "idx_deliverables_user_id")
  @@index([workspace_id], map: "idx_deliverables_workspace_id")
  @@index([workspace_id, user_id, type], map: "idx_deliverables_workspace_user_type")
  @@index([type], map: "idx_deliverables_type")
  @@map("deliverables")
  @@schema("public")
}

model UserFavorite {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  prompt_id  Int
  created_at DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
    
  @@unique([user_id, prompt_id])
  @@index([user_id], map: "idx_user_favorites_user_id")
  @@map("user_favorites")
  @@schema("public")
}

model AIToolFavorite {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  tool_id    String
  created_at DateTime @default(dbgenerated("timezone('utc'::text, now())")) @db.Timestamptz(6)
       
  @@unique([user_id, tool_id])
  @@index([user_id], map: "idx_aitool_favorites_user_id")
  @@map("aitool_favorites")
  @@schema("public")
}

// NEW: User Credits System
model UserCredit {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String   @unique @db.Uuid
  credits           Int      @default(0)
  free_leads_used   Int      @default(0) @map("free_leads_used")
  total_purchased   Int      @default(0) @map("total_purchased")
  created_at        DateTime @default(dbgenerated("timezone('utc'::text, now())")) @map("created_at") @db.Timestamptz(6)
  updated_at        DateTime @default(dbgenerated("timezone('utc'::text, now())")) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([user_id], map: "idx_user_credits_user_id")
  @@map("user_credits")
  @@schema("public")
}

// NEW: Credit Transaction History
model CreditTransaction {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String    @db.Uuid
  workspace_id     String?   @db.Uuid
  amount           Int       // Positive for credits added, negative for credits used
  transaction_type String    @map("transaction_type") @db.VarChar(50) // 'purchase', 'usage', 'refund', 'bonus', 'free_usage'
  description      String?
  reference_id     String?   @map("reference_id") // Link to deliverable or payment
  metadata         Json?
  created_at       DateTime  @default(dbgenerated("timezone('utc'::text, now())")) @map("created_at") @db.Timestamptz(6)

  workspace Workspace? @relation(fields: [workspace_id], references: [id], onDelete: SetNull)
  
  @@index([user_id], map: "idx_credit_transactions_user_id")
  @@index([user_id, transaction_type], map: "idx_credit_transactions_user_type")
  @@index([transaction_type], map: "idx_credit_transactions_type")
  @@index([created_at], map: "idx_credit_transactions_created_at")
  @@map("credit_transactions")
  @@schema("public")
}